generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum Role {
  ADMIN
  TECHNICIAN
  CLIENT
}

enum ServiceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CLOSED // Servicio cerrado y bloqueado
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  OTHER
}

enum EstimateStatus {
  SENT
  APPROVED
  REJECTED
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String
  role         Role
  avatar       String?
  passwordHash String
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  servicesAsTechnician Service[]  @relation("TechnicianServices")
  servicesCreated      Service[]  @relation("CreatedServices")
  servicesClosed       Service[]  @relation("ClosedServices")
  payments             Payment[]  @relation("TechnicianPayments")
  estimates            Estimate[]
}

model Client {
  id        String     @id @default(uuid())
  name      String
  email     String     @unique
  phone     String?
  address   String?
  city      String?
  notes     String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  services  Service[]
  estimates Estimate[]
}

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  color       String?
  icon        String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]
}

model Service {
  id             String        @id @default(uuid())
  title          String
  description    String?
  status         ServiceStatus @default(PENDING)
  scheduledDate  DateTime
  scheduledTime  String
  address        String? // Direcci√≥n del servicio
  completedAt    DateTime?
  notes          String?
  expectedAmount Decimal?      @db.Decimal(10, 2) // Monto esperado, editable hasta cierre
  closedAt       DateTime?
  isLocked       Boolean       @default(false) // Helper, pero status=CLOSED es la autoridad
  technicianId   String?
  clientId       String?
  createdById    String
  closedById     String?
  categoryId     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  technician User?            @relation("TechnicianServices", fields: [technicianId], references: [id])
  client     Client?          @relation(fields: [clientId], references: [id])
  createdBy  User             @relation("CreatedServices", fields: [createdById], references: [id])
  closedBy   User?            @relation("ClosedServices", fields: [closedById], references: [id])
  category   ServiceCategory? @relation(fields: [categoryId], references: [id])
  payment    Payment?
  estimate   Estimate?

  @@index([technicianId])
  @@index([clientId])
  @@index([status])
  @@index([categoryId])
}

model Payment {
  id             String        @id @default(uuid())
  method         PaymentMethod
  amountPaid     Decimal       @db.Decimal(10, 2) // Monto efectivamente cobrado
  sparePartsCost Decimal       @default(0) @db.Decimal(10, 2) // valor de repuestos
  debtAmount     Decimal       @default(0) @db.Decimal(10, 2) // debe
  hasDebt        Boolean       @default(false) // 
  notes          String?
  technicianId   String
  serviceId      String        @unique
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  technician User    @relation("TechnicianPayments", fields: [technicianId], references: [id])
  service    Service @relation(fields: [serviceId], references: [id])

  @@index([technicianId])
}

model Estimate {
  id           String         @id @default(uuid())
  serviceId    String         @unique
  technicianId String
  clientId     String
  amount       Decimal        @db.Decimal(10, 2)
  description  String?
  status       EstimateStatus @default(SENT)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  service    Service @relation(fields: [serviceId], references: [id])
  technician User    @relation(fields: [technicianId], references: [id])
  client     Client  @relation(fields: [clientId], references: [id])

  @@index([status])
}
